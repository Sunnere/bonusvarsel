name: BonusVarsel – collect & notify

on:
  workflow_dispatch:
    inputs:
      force_notify:
        description: "Send Telegram selv om det ikke er endringer"
        required: false
        default: "false"
      only_program:
        description: "Kjør kun ett program (tom = alle). Eks: sas / turkish / lufthansa"
        required: false
        default: ""

  schedule:
    # 07:15 norsk tid-ish avhenger av GitHub (UTC). Juster ved behov.
    - cron: "15 6 * * *"

jobs:
  run:
    name: run (${{ matrix.program }}, ${{ matrix.channel }}, ${{ matrix.country }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - program: sas
            channel: SAS
            country: no
            display_name: "SAS EuroBonus"
            alliance: "SkyTeam"

          - program: turkish
            channel: TURKISH
            country: no
            display_name: "Turkish Miles&Smiles"
            alliance: ""

          - program: lufthansa
            channel: LUFTHANSA
            country: no
            display_name: "Lufthansa Miles & More"
            alliance: "Star Alliance"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Kjør bare ønsket program hvis only_program er satt
      - name: Skip if not selected
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.only_program != '' && github.event.inputs.only_program != matrix.program }}
        run: |
          echo "Skipping (only_program=${{ github.event.inputs.only_program }})"
          exit 0

      - name: Collect (writes to data/<program>/)
        env:
          PROGRAM: ${{ matrix.program }}
          CHANNEL: ${{ matrix.channel }}
          COUNTRY: ${{ matrix.country }}
          LANGUAGE: nb
          PER_PAGE: "100"
        run: |
          node scripts/collect-loyaltykey.mjs

      # Commit/push bare hvis data endret seg
      - name: Commit data if changed
        run: |
          git config user.name "bonusvarsel-bot"
          git config user.email "actions@users.noreply.github.com"

          git add -A data/${{ matrix.program }} || true

          if git diff --cached --quiet; then
            echo "No data changes to commit."
            exit 0
          fi

          git commit -m "data(${{
            matrix.program
          }}): update"
          git push

      # Send Telegram kun hvis changes.json finnes (collector må ha skrevet ut)
      - name: Notify Telegram
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          PROGRAM: ${{ matrix.program }}
          CHANNEL: ${{ matrix.channel }}
          COUNTRY: ${{ matrix.country }}
        run: node scripts/notify-from-changes.mjs

          if [ ! -f "data/${{ matrix.program }}/changes.json" ]; then
            echo "No changes.json found for program=${{ matrix.program }} (skipping notify)"
            exit 0
          fi

          FORCE="${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force_notify == 'true' }}"
          if [ "$FORCE" = "true" ]; then
            node scripts/notify-from-changes.mjs --force
          else
            node scripts/notify-from-changes.mjs
          fi
